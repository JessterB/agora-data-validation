---
title: "gene_info_test"
---

See the following files and paired rules files for gene_info subobject validation:
* gene_info_druggability_test.R & rules_gene_info_druggability.R
* gene_info_median_expression_test.R & rules_gene_info_median_expression.R
* gene_info_nominatedtarget_test.R & rules_gene_info_nominatedtarget.R

```{r eval=FALSE, echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
prepare()
```

# Validation run metadata
```{r echo=FALSE}
# file-specific
name <- "gene_info"

# source files
gene_source_synId <- "syn25953363.4" # gene_table_merged.feather
igap_source_synId <- "syn12514826.4" # igap_genetic_association_genes.csv
eqtl_source_synId <- "syn12514912.3" # eqtl_meta_analysis.csv
proteomics_source_synId <- "syn18689335.3" # Final_Agora_DE.csv
proteomics_tmt_source_synId <- "syn35221005.2" # ROSMAP_DiffExp_TMTproteins.csv
rna_de_source_synId <- "syn27211942.1" # differentialExpressionSummary.tsv

# json files
old_synId <-  "syn12548902.39" # m49 Live
new_synId <- "syn17015359" 

# not file-specific
old_name <- paste(name, "old", sep="_")
new_name <- paste(name, "new", sep="_")
rules <- paste0("rules_", name)

# print validation summary
cat( name, ".json", "\nReported on:  ", date(),
    "\nold: ", old_synId, " \nnew: ", new_synId,
    sep="")
```

# Downloaded files to compare
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
download_files(old_synId, new_synId, name)
```

# Download source files
```{r}
gene <- download_file(gene_source_synId, type = "f") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
igap <- download_file(igap_source_synId, type = "csv") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
eqtl <- download_file(eqtl_source_synId, type = "csv") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
proteomics <- download_file(proteomics_source_synId, type = "csv") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
proteomics_tmt <- download_file(proteomics_tmt_source_synId, type = "csv") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
rna_de <- download_file(rna_de_source_synId, type = "tsv") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
```

# Compared old & new files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare(get(old_name), get(new_name), name)
```

# Validated new file against rules
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_gene_info.R")
test(get(new_name), get(rules))
```

***
# Outstanding validation failures
***
* !is.na(hgnc_symbol)/field_length(hgnc_symbol, min = 0, max = 100): 19367 - NA values
* !is.na(nominations)/nominations > 0/lengths(nominatedtarget) > 0: 67979 fails (only expect nominated targets to pass this one)
* !is.na(name)/field_length(name, min = 0, max = 200): 19368 - NA values
* !is.na(summary): 44167 fails - NA values

***
# Validation failure investigations
```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(VALIDATION_RULE)
cf <- confront(DATAFRAME, v)
out <- values(cf)
is_unique_fails <- DATAFRAME[!out,]
is_unique_fails
```



## is_unique(ensembl_gene_id): 2 fails (7/19/22) -> 4 fails (9/29/22)
dups are identical outside of hgnc/name fields
```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(is_unique(ensembl_gene_id))
cf <- confront(gene_info_new, v)
out <- values(cf)
is_unique_fails <- gene_info_new[!out,]
is_unique_fails

# is medianexpression data identical for the dups?
LOC101927745 <- is_unique_fails[is_unique_fails$hgnc_symbol == 'LOC101927745',]
LOC105369302 <- is_unique_fails[is_unique_fails$hgnc_symbol == 'LOC105369302',]
identical(LOC101927745$medianexpression, LOC105369302$medianexpression)

LOC107987420 <- is_unique_fails[is_unique_fails$hgnc_symbol == 'LOC107987420',]
LOC107987434 <- is_unique_fails[is_unique_fails$hgnc_symbol == 'LOC107987434',]
identical(LOC107987420$medianexpression, LOC107987434$medianexpression)
```

##  !is.na(summary): 5 fails -> 42406 fails
-> !is.na(summary): 42406 fails - spot check shows these were blank strings before, nulls now, seems fine

```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(!is.na(summary))
cf <- confront(gene_info_new, v)
out <- values(cf)
is_unique_fails <- gene_info_new[!out,]
is_unique_fails
```
```{r}
gene_info_old[gene_info_old$ensembl_gene_id == "ENSG00000002933",]
```



***
Misc investigations
***
## Poster stats
```{r}
nominated_targets_new <- get_subobject(gene_info_new, "nominatedtarget")

amp_nt <- nominated_targets_new[nominated_targets_new$source == 'AMP-AD',]
treat_nt <- nominated_targets_new[nominated_targets_new$source == 'TREAT-AD',]
com_nt <- nominated_targets_new[nominated_targets_new$source == 'Community',]
res_nt <- nominated_targets_new[nominated_targets_new$source == 'Resilience-AD',]

length(unique(amp_nt$ensembl_gene_id))
length(unique(treat_nt$ensembl_gene_id))
length(unique(com_nt$ensembl_gene_id))
length(unique(res_nt$ensembl_gene_id))
```







## TMT boolean flip validation
```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000134684" ,]
```
```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000134684", ]
```
```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000183735", ]
```

## AG-474: proteomics booleans


```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000142892" ,]
proteomics_new[proteomics_new$ensembl_gene_id == "ENSG00000142892" ,]
```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000142892',]

```


spot checks
```{r}
prot_mins <- proteomics_new %>% group_by(ensembl_gene_id) %>% arrange(cor_pval) %>% slice(1)
prot_mins
```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000008018',]
```

```{r}
prot <- proteomics_new$ensembl_gene_id
gene_info <- gene_info_new$ensembl_gene_id

setdiff(gene_info, prot) # these should have studied == false

```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000078618',]
```

## AG-530: RNA booleans
```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000233009" ,]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == "ENSG00000233009" ,]
```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000200882" ,]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == "ENSG00000200882" ,]
```

```{r}
mins <- rna_seq_differential_expression_new %>% group_by(ensembl_gene_id) %>% arrange(adj_p_val) %>% slice(1)
mins
```

```{r}
studied <- rna_seq_differential_expression_new$ensembl_gene_id
gene_info <- gene_info_new$ensembl_gene_id

setdiff(gene_info, studied)  # these should have studied == false

```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000144158" ,]
```


## The missing NA (AG-368) 

```{r}
gene_info_new[gene_info_new$hgnc_symbol == 'DNAH9',]
gene_info_new[gene_info_new$hgnc_symbol == 'DH9',]
gene_info_old[gene_info_old$hgnc_symbol == 'DNAH9',]
```

# Cross-file investigation of genes w/o hgnc/name

get ensgs for rows with no hgnc
```{r}
v <- validator(field_length(hgnc_symbol, min = 2, max = 100))
cf <- confront(gene_info_new, v)
out <- values(cf)
is_unique_fails <- gene_info_new[!out,]
ensgs <- is_unique_fails[[1]]
print(ensgs)
print(is_unique_fails[order(is_unique_fails$ensembl_gene_id),])
```


how many of them are missing median_expression data? 
-> 18255/20011
```{r}
me_nulls <- sum(is_unique_fails[13] == "NULL")
print(me_nulls)
```

how many have RNA DE data?
->
```{r}
rnade_matches <- rna_seq_differential_expression_new$ensembl_gene_id %in% ensgs
#print(sum(rnade_matches))

rnade_results <- rna_seq_differential_expression_new[rnade_matches,] 

rnade_rows <- rnade_results[order(rnade_results$ensembl_gene_id),]

rnade_ensgs <- table(rnade_rows$ensembl_gene_id)
print(length(rnade_ensgs))

```

how many have proteomic data?
```{r}
prot_matches <- proteomics_new$ensemble_gene_id %in% ensgs
print(sum(prot_matches))
```

how many have metabolomic data?
```{r}
met_matches <- metabolomics_new$ensemble_gene_id %in% ensgs
print(sum(met_matches))
```


## Misc investigations

how many cohort studies?
```{r}
targets <- get_subobject(gene_info_old, "nominatedtarget")
studies <- targets$study
s <- as.list(unlist(strsplit(studies, '[[:space:]]')))
unique(gsub(",","",s))
```


AG-168 - are the missing nominations in the new file??

```{r}
targets_source <- download_file("syn12540368", "targets_source", "csv")
```

how many nominated targets should we have according to the source data? => 693
```{r}
nrow(targets_source)
```

how many targets did we have in the old file? => 668/693
```{r}
old_targets <- get_subobject(gene_info_old, "nominatedtarget")
nrow(old_targets)
```

Which 25 are missing?
```{r}
source_ensgs <- targets_source$ensembl_gene_id
source_hgncs <- targets_source$hgnc_symbol

gene_info_old[gene_info_old$ensembl_gene_id %in% source_ensgs, ]

```


how many targets are in the old file? => 692/693
```{r}
new_targets <- get_subobject(gene_info_new, "nominated_target")
source_ensgs <- targets_source$ensembl_gene_id
nrow(new_targets)
```
What's missing?
- 19 genes from source were missing in old and are present in new

```{r}
 #ensg <- 'ENSG00000283632' EXOC3L2 - this needs special examination because it throws an error (hence the else below)

i <- 1

for (ensg in source_ensgs) {
source_nomination <- targets_source[targets_source$ensembl_gene_id == ensg,]
old_row <- gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
new_row <- gene_info_new[gene_info_new$ensembl_gene_id == ensg,]

old_nomination <- old_row$nominatedtarget
new_nomination <- new_row$nominated_target

if (length(old_nomination) > 0) {
  print(c(i, ensg, length(source_nomination), length(old_nomination[[1]]), length(new_nomination[[1]])))
} else {
    print(c(i, ensg, length(source_nomination), "--",  "--"))
}


i <- i + 1
}
```

```{r}
i <- 1

for (hgnc in source_hgncs) {
source_nomination <- targets_source[targets_source$hgnc_symbol == hgnc,]
old_row <- gene_info_old[gene_info_old$hgnc_symbol == hgnc,]
new_row <- gene_info_new[gene_info_new$hgnc_symbol == hgnc,]

old_nomination <- old_row$nominatedtarget
new_nomination <- new_row$nominated_target

#print(hgnc)

if (length(old_nomination) > 0 && length(new_nomination) > 0) {
  print(c(i, hgnc, length(source_nomination), length(old_nomination[[1]]), length(new_nomination[[1]])))
} else {
    print(c(i, hgnc, length(source_nomination), "--",  "--"))
}


i <- i + 1
}
```


ENSG00000283632 EXOC3L2 is missing from both old and new gene_info, why???

```{r}
ensg <- 'ENSG00000246451'
hgnc <- 'RP11-894P9.1'

targets_source[targets_source$ensembl_gene_id == ensg,]
gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
gene_info_new[gene_info_new$ensembl_gene_id == ensg,]

targets_source[targets_source$hgnc_symbol == hgnc,]
gene_info_old[gene_info_old$hgnc_symbol == hgnc,]
gene_info_new[gene_info_new$hgnc_symbol ==  hgnc,]
```


```{r}
ensg <- 'ENSG00000162771'
hgnc <- 'FAM71A'

targets_source[targets_source$ensembl_gene_id == ensg,]
gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
gene_info_new[gene_info_new$ensembl_gene_id == ensg,]

targets_source[targets_source$hgnc_symbol == hgnc,]
gene_info_old[gene_info_old$hgnc_symbol == hgnc,]
gene_info_new[gene_info_new$hgnc_symbol ==  hgnc,]
```


AG-252/AG-409

```{r}
sum(is.na(gene_info_new$isAnyRNAChangedInADBrain))
sum(is.na(gene_info_new$isAnyProteinChangedInADBrain))
sum(is.na(gene_info_new$isIGAP))
sum(is.na(gene_info_new$haseqtl))

sum(!is.na(gene_info_new$isAnyRNAChangedInADBrain))
sum(!is.na(gene_info_new$isAnyProteinChangedInADBrain))
sum(!is.na(gene_info_new$isIGAP))
sum(!is.na(gene_info_new$haseqtl))

nrow(gene_info_new)
```

New genes
```{r}
old_ensgs <- gene_info_old$ensembl_gene_id
new_ensgs <- gene_info_new$ensembl_gene_id

setdiff(new_ensgs, old_ensgs)
```


```{r}
nominations <- get_subobject(gene_info_old, "nominatedtarget")
synIds <- nominations$data_synapseid

print(synIds)
```


```{r}
not_studied <- gene_info_new[gene_info_new$rna_brain_change_studied == TRUE,]
gene_info_new[gene_info_new$isAnyRNAChangedInADBrain == FALSE,]
```

```{r}
studied <- gene_info_new[gene_info_new$rna_brain_change_studied == TRUE ,]
changed <- studied[studied$isAnyRNAChangedInADBrain == TRUE ,]
```

```{r}
nt <- gene_info_new[gene_info_new$nominations %in% c(4, 3, 2, 1),]
baru <- nt[grepl("BARU", nt$nominatedtarget, fixed = TRUE),]
longo <- nt[grepl("Longo", nt$nominatedtarget, fixed = TRUE),]
chang <- nt[grepl("Chang", nt$nominatedtarget, fixed = TRUE),]
```

```{r}
gene <- gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000138741',]
gene$nominatedtarget
```


## Data validation for 3.0
2 new rows, but apparently no new ENSGs - duplicate ensgs w/different hgncs - AG-691
```{r}
setdiff(gene_info_new, gene_info_old)
setdiff(gene_info_old, gene_info_new)

setdiff(gene_info_new$ensembl_gene_id, gene_info_old$ensembl_gene_id)
setdiff(gene_info_old$ensembl_gene_id, gene_info_new$ensembl_gene_id)
```

## uncharacterized LOCs AG-691)
```{r}
ulocs <- startsWith(gene_info_new$name, "uncharacterized")
locs <- startsWith(gene_info_new$hgnc_symbol, "LOC")

name_results <- which(ulocs == TRUE)
hgnc_results <- which(locs == TRUE)

uloc_names <- gene_info_new[name_results,]
loc_hgncs <- gene_info_new[hgnc_results,]

setdiff(loc_hgncs, uloc_names)
setdiff(uloc_names, loc_hgncs)
```

spot checks
PLEC: 4 -> 5 nominations
```{r}
plec_new <- gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000178209",]
plec_old <- gene_info_old[gene_info_old$ensembl_gene_id == "ENSG00000178209",]
identical(plec_new, plec_old)
print(plec_new)
print(plec_old)
```


# ENSG refresh

spot checks for identical results using a handful of ENSGs that we had prior to the refactor
```{r}
ensgs = list("ENSG00000178209", "ENSG00000000003", "ENSG00000142892", "ENSG00000233009", "ENSG00000200882", "ENSG00000152413")
for (ensg in ensgs) {
  new <- gene_info_new[gene_info_new$ensembl_gene_id == ensg,]
  old <- gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
rownames(new) <- NULL
rownames(old) <- NULL

cat("\n",ensg)
cat("\n  identical: ", identical(new, old))
cat("\n  equal: ", all.equal(new, old))
}
```
```{r}
ensgs_new <- gene_info_new['ensembl_gene_id']
nrow(ensgs_new)
nrow(unique(ensgs_new))

ensgs_old <- gene_info_old['ensembl_gene_id']
nrow(ensgs_old)
nrow(unique(ensgs_old))
```


AG-948 - nomination sorting bug

is it due to ordering in the data? -> seems not
```{r}
plec <- gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000178209',]
plec$nominatedtarget
```

