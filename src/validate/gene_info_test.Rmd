---
title: "gene_info_test"
output: html_notebook
---

```{r eval=FALSE, echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
prepare()
```

# Validation run metadata
```{r echo=FALSE}
# file-specific
name <- "gene_info"
old_synId <-  "syn12548902" 
new_synId <- "syn17015359" 

# not file-specific
old_name <- paste(name, "old", sep="_")
new_name <- paste(name, "new", sep="_")
rules <- paste0("rules_", name)

# print validation summary
cat( name, ".json", "\nReported on:  ", date(),
    "\nold: ", old_synId, " \nnew: ", new_synId,
    sep="")
```

# Downloaded files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
download_files(old_synId, new_synId, name)
```


# Compared old & new files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare(get(old_name), get(new_name), name)
```

## Compare old & new subobjects


### median_expression
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare_subobjects(get(old_name), get(new_name), "medianexpression", "medianexpression")
```

### druggability
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare_subobjects(get(old_name), get(new_name), "druggability")
```

### nominatedtarget
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare_subobjects(get(old_name), get(new_name), "nominatedtarget", "nominatedtarget")
```


# Validated new file against rules
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_gene_info.R")
test(get(new_name), get(rules))
```

## Validated subobjects against rules

### nominated_target
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_gene_info_nominated_target.R")

subrules <- paste0(rules, "_nominated_target")
test_subobject(get(new_name), "nominatedtarget", get(subrules))
```

### druggability
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_gene_info_druggability.R")

subrules <- paste0(rules, "_druggability")
test_subobject(get(new_name), "druggability", get(subrules))
```

### median_expression
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_gene_info_median_expression.R")

subrules <- paste0(rules, "_median_expression")
test_subobject(get(new_name), "medianexpression", get(subrules))
```

***
# Outstanding validation failures
***
* nominated target: field_length(data_used_to_support_target_selection, min = 15, max = 2000): 2 fails - see AG-365
* !is.na(summary): 5 fails 

***
# Validation failure investigations
```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(VALIDATION_RULE)
cf <- confront(DATAFRAME, v)
out <- values(cf)
is_unique_fails <- DATAFRAME[!out,]
is_unique_fails
```


##  !is.na(summary): 5 fails
-> !is.na(summary): 42406 fails - spot check shows these were blank strings before, nulls now, seems fine

```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(!is.na(summary))
cf <- confront(gene_info_new, v)
out <- values(cf)
is_unique_fails <- gene_info_new[!out,]
is_unique_fails
```
```{r}
gene_info_old[gene_info_old$ensembl_gene_id == "ENSG00000002933",]
```

## AG-365 Missing/optional NT fields

```{r}
nominated_targets <- get_subobject(gene_info_new, "nominatedtarget")
```

```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(field_length(data_synapseid, min = 3, max = 25))
cf <- confront(nominated_targets, v)
out <- values(cf)
is_unique_fails <- nominated_targets[!out,]
is_unique_fails
```



## AG-474: proteomics booleans


```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000142892" ,]
proteomics_new[proteomics_new$ensembl_gene_id == "ENSG00000142892" ,]
```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000142892',]

```


spot checks
```{r}
prot_mins <- proteomics_new %>% group_by(ensembl_gene_id) %>% arrange(cor_pval) %>% slice(1)
prot_mins
```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000008018',]
```

```{r}
prot <- proteomics_new$ensembl_gene_id
gene_info <- gene_info_new$ensembl_gene_id

setdiff(gene_info, prot) # these should have studied == false

```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == 'ENSG00000078618',]
```

## AG-530: RNA booleans
```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000233009" ,]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == "ENSG00000233009" ,]
```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000200882" ,]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == "ENSG00000200882" ,]
```



```{r}
mins <- rna_seq_differential_expression_new %>% group_by(ensembl_gene_id) %>% arrange(adj_p_val) %>% slice(1)
mins
```

```{r}
studied <- rna_seq_differential_expression_new$ensembl_gene_id
gene_info <- gene_info_new$ensembl_gene_id

setdiff(gene_info, studied)  # these should have studied == false

```

```{r}
gene_info_new[gene_info_new$ensembl_gene_id == "ENSG00000144158" ,]
```


## The missing NA (AG-368) 

```{r}
gene_info_new[gene_info_new$hgnc_symbol == 'DNAH9',]
gene_info_new[gene_info_new$hgnc_symbol == 'DH9',]
gene_info_old[gene_info_old$hgnc_symbol == 'DNAH9',]
```

## AG-365 field_length(data_used_to_support_target_selection, min = 1, max = 2000): 2 fails

Analysis:
- These values are missing in both the old data (verified in app & mongo) and in the source data
- Only impacts two genes (REST, HDAC1)
- The app doesn't conditionally handle this, so we have a header with no content for these


```{r}
subobj <- get_subobject(gene_info_new, "nominatedtarget")
v <- validator(field_length(data_used_to_support_target_selection, min = 15, max = 2000))
cf <- confront(subobj, v)
out <- values(cf)
is_unique_fails <- subobj[!out,]
is_unique_fails
```

Are there values in the source data?
=> nope

```{r}
nominated_target_source <- download_file("syn12540368", type = "csv")
```

```{r}
nominated_target_source[nominated_target_source$hgnc_symbol %in% c("REST", "HDAC1"),]
```




# Cross-file investigation of genes w/o hgnc/name

get ensgs for rows with no hgnc
```{r}
v <- validator(field_length(hgnc_symbol, min = 2, max = 100))
cf <- confront(gene_info_new, v)
out <- values(cf)
is_unique_fails <- gene_info_new[!out,]
ensgs <- is_unique_fails[[1]]
print(ensgs)
print(is_unique_fails[order(is_unique_fails$ensembl_gene_id),])
```


how many of them are missing median_expression data? 
-> 18255/20011
```{r}
me_nulls <- sum(is_unique_fails[13] == "NULL")
print(me_nulls)
```

how many have RNA DE data?
->
```{r}
rnade_matches <- rna_seq_differential_expression_new$ensembl_gene_id %in% ensgs
#print(sum(rnade_matches))

rnade_results <- rna_seq_differential_expression_new[rnade_matches,] 

rnade_rows <- rnade_results[order(rnade_results$ensembl_gene_id),]

rnade_ensgs <- table(rnade_rows$ensembl_gene_id)
print(length(rnade_ensgs))

```

how many have proteomic data?
```{r}
prot_matches <- proteomics_new$ensemble_gene_id %in% ensgs
print(sum(prot_matches))
```

how many have metabolomic data?
```{r}
met_matches <- metabolomics_new$ensemble_gene_id %in% ensgs
print(sum(met_matches))
```


## Misc investigations

how many cohort studies?
```{r}
targets <- get_subobject(gene_info_old, "nominatedtarget")
studies <- targets$study
s <- as.list(unlist(strsplit(studies, '[[:space:]]')))
unique(gsub(",","",s))
```


AG-168 - are the missing nominations in the new file??

```{r}
targets_source <- download_file("syn12540368", "targets_source", "csv")
```

how many nominated targets should we have according to the source data? => 693
```{r}
nrow(targets_source)
```

how many targets did we have in the old file? => 668/693
```{r}
old_targets <- get_subobject(gene_info_old, "nominatedtarget")
nrow(old_targets)
```

Which 25 are missing?
```{r}
source_ensgs <- targets_source$ensembl_gene_id
source_hgncs <- targets_source$hgnc_symbol

gene_info_old[gene_info_old$ensembl_gene_id %in% source_ensgs, ]

```


how many targets are in the old file? => 692/693
```{r}
new_targets <- get_subobject(gene_info_new, "nominated_target")
source_ensgs <- targets_source$ensembl_gene_id
nrow(new_targets)
```
What's missing?
- 19 genes from source were missing in old and are present in new

```{r}
 #ensg <- 'ENSG00000283632' EXOC3L2 - this needs special examination because it throws an error (hence the else below)

i <- 1

for (ensg in source_ensgs) {
source_nomination <- targets_source[targets_source$ensembl_gene_id == ensg,]
old_row <- gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
new_row <- gene_info_new[gene_info_new$ensembl_gene_id == ensg,]

old_nomination <- old_row$nominatedtarget
new_nomination <- new_row$nominated_target

if (length(old_nomination) > 0) {
  print(c(i, ensg, length(source_nomination), length(old_nomination[[1]]), length(new_nomination[[1]])))
} else {
    print(c(i, ensg, length(source_nomination), "--",  "--"))
}


i <- i + 1
}
```

```{r}
i <- 1

for (hgnc in source_hgncs) {
source_nomination <- targets_source[targets_source$hgnc_symbol == hgnc,]
old_row <- gene_info_old[gene_info_old$hgnc_symbol == hgnc,]
new_row <- gene_info_new[gene_info_new$hgnc_symbol == hgnc,]

old_nomination <- old_row$nominatedtarget
new_nomination <- new_row$nominated_target

#print(hgnc)

if (length(old_nomination) > 0 && length(new_nomination) > 0) {
  print(c(i, hgnc, length(source_nomination), length(old_nomination[[1]]), length(new_nomination[[1]])))
} else {
    print(c(i, hgnc, length(source_nomination), "--",  "--"))
}


i <- i + 1
}
```


ENSG00000283632 EXOC3L2 is missing from both old and new gene_info, why???

```{r}
ensg <- 'ENSG00000246451'
hgnc <- 'RP11-894P9.1'

targets_source[targets_source$ensembl_gene_id == ensg,]
gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
gene_info_new[gene_info_new$ensembl_gene_id == ensg,]

targets_source[targets_source$hgnc_symbol == hgnc,]
gene_info_old[gene_info_old$hgnc_symbol == hgnc,]
gene_info_new[gene_info_new$hgnc_symbol ==  hgnc,]
```


```{r}
ensg <- 'ENSG00000162771'
hgnc <- 'FAM71A'

targets_source[targets_source$ensembl_gene_id == ensg,]
gene_info_old[gene_info_old$ensembl_gene_id == ensg,]
gene_info_new[gene_info_new$ensembl_gene_id == ensg,]

targets_source[targets_source$hgnc_symbol == hgnc,]
gene_info_old[gene_info_old$hgnc_symbol == hgnc,]
gene_info_new[gene_info_new$hgnc_symbol ==  hgnc,]
```


AG-252/AG-409

```{r}
sum(is.na(gene_info_new$isAnyRNAChangedInADBrain))
sum(is.na(gene_info_new$isAnyProteinChangedInADBrain))
sum(is.na(gene_info_new$isIGAP))
sum(is.na(gene_info_new$haseqtl))

sum(!is.na(gene_info_new$isAnyRNAChangedInADBrain))
sum(!is.na(gene_info_new$isAnyProteinChangedInADBrain))
sum(!is.na(gene_info_new$isIGAP))
sum(!is.na(gene_info_new$haseqtl))

nrow(gene_info_new)
```

New genes
```{r}
old_ensgs <- gene_info_old$ensembl_gene_id
new_ensgs <- gene_info_new$ensembl_gene_id

setdiff(new_ensgs, old_ensgs)
```


```{r}
nominations <- get_subobject(gene_info_old, "nominatedtarget")
synIds <- nominations$data_synapseid

print(synIds)
```


```{r}
not_studied <- gene_info_new[gene_info_new$rna_brain_change_studied == TRUE,]
gene_info_new[gene_info_new$isAnyRNAChangedInADBrain == FALSE,]
```

```{r}
gene_info_new[gene_info_new$hgnc_symbol == '',]
```