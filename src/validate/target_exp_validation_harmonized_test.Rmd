---
title: "target_exp_validation_harmonized.json"
---

```{r eval=FALSE, echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
prepare()
```

# Validation run metadata
```{r echo=FALSE}
# file-specific
name <- "target_exp_validation_harmonized"
source_synId <- "syn2580853" #csv
old_synId <-  "syn25741027" # m46 v11 Live
new_synId <- "syn25740978" # v51 Testing


# not file-specific
source_name <- paste(name, "source", sep="_")
old_name <- paste(name, "old", sep="_")
new_name <- paste(name, "new", sep="_")
rules <- paste0("rules_", name)

# print validation summary
cat( name, ".json", "\n", date(),
    "\nold: ", old_synId, " \nnew: ", new_synId,
    sep="")
```

# Downloaded files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
download_files(old_synId, new_synId, name)
```

```{r}
source <- download_file(source_synId, type = "csv") 
assign(paste(name, "source", sep="_"), source, envir = .GlobalEnv)
```


# Compared old & new files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare(get(old_name), get(new_name), name)
```


# Validated new file against rules
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_target_exp_validation_harmonized.R")
test(get(new_name), get(rules))
```

***
# Outstanding validation failures
***

* field_length(ensembl_gene_id, n = 15): 1 fail - See AG-351

* field_format(reference_doi, "^$|^https?://doi.org/.*$", type = "regex"): 103 fails [changed from "" to null via AG-474]

***
# Validation failure investigations
***


## field_format(reference_doi, "^$|^https?://doi.org/.*$", type = "regex")
```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(field_format(reference_doi, "^$|^https?://doi.org/.*$", type = "regex"))
cf <- confront(target_exp_validation_harmonized_new, v)
out <- values(cf)
is_unique_fails <- target_exp_validation_harmonized_new[!out,]
is_unique_fails
```


## 	AG-351: field_length(ensembl_gene_id, n = 15): 1 fail

* This is from the source data
* AG-351

```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(field_length(ensembl_gene_id, n = 15))
cf <- confront(target_exp_validation_harmonized_new, v)
out <- values(cf)
is_unique_fails <- target_exp_validation_harmonized_new[!out,]
is_unique_fails
```

was this issue present in the old data file? => yes
```{r}
target_exp_validation_harmonized_old[target_exp_validation_harmonized_old$ensembl_gene_id == "",]
```


is this from the source data?

=> yes 

```{r}
target_exp_validation_harmonized_source[target_exp_validation_harmonized_source$hgnc_symbol == "FC1 (mouse)",]
```


## do we have missing data for Exp Val that we need to conditionalize header display to handle?
```{r}
#row <- target_exp_validation_harmonized_old[target_exp_validation_harmonized_old$ensembl_gene_id == 'ENSG00000178209',]
#row$reference_doi

sapply(target_exp_validation_harmonized_source, function(x) sum(x == "")
```


```{r}
target_exp_validation_harmonized_new[target_exp_validation_harmonized_new$ensembl_gene_id == 'ENSG00000138741',]
```