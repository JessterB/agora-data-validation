---
title: "rna_seq_differential_expression.json"
output: html_notebook
---

```{r eval=FALSE, echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
prepare()
```

# Validation run metadata
```{r echo=FALSE}
# file-specific
source_synId <- "syn27211942" # tsv
old_synId <-  "syn12177499" 
new_synId <- "syn17015360" 

name <- "rna_seq_differential_expression"

# not file-specific
old_name <- paste(name, "old", sep="_")
new_name <- paste(name, "new", sep="_")
rules <- paste0("rules_", name)

# print validation summary
cat( name, ".json", "\n", date(),
    "\nold: ", old_synId, " \nnew: ", new_synId,
    sep="")
```

# Downloaded files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
download_files(old_synId, new_synId, name)
```

# Compared old & new files
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
compare(get(old_name), get(new_name), name, summarize=FALSE)
```


# Validated new file against rules
```{r echo=FALSE}
source("~/repos/rstudio/agora-data-validation/src/utils.R")
source("~/repos/rstudio/agora-data-validation/src/rules/rules_rna_seq_differential_expression.R")
test(get(new_name), get(rules))
```

***
# Outstanding validation failures
***

* is_unique(model, tissue, ensembl_gene_id): 72 fails 

We have identical duplicates for ENSG00000229425/AJ009632.2 (9 tissues x 4 models x 2 = 72)
=> these duplicates should not cause issues in the app


AG-451

***
# Validation failure investigations
***

```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(	is_unique(RULE))
cf <- confront(rna_seq_differential_expression_new, v)
out <- values(cf)
is_unique_fails <- rna_seq_differential_expression_new[!out,]
is_unique_fails
```


## is_unique(model, tissue, ensembl_gene_id): 72 fails

These are due to pairs of identical duplicate records for every model/tissue combination fro a single gene: 
9 x 4 = 36 expected x 2 for duplicates = 72

Not sure why we have dups, but they should be harmless.


```{r}
# yields a dataframe containing the failure cases for a specific rule
v <- validator(	is_unique(model, tissue, ensembl_gene_id))
cf <- confront(rna_seq_differential_expression_new, v)
out <- values(cf)
is_unique_fails <- rna_seq_differential_expression_new[!out,]
is_unique_fails
```

Are the dups from the source table?
36 matching rows in source,which equals expected rows
=> no

```{r}
 rna_de_source <- download_file("syn27211942", "rna_seq_source", "tsv")

rows <- rna_de_source[rna_de_source$ensembl_gene_id == 'ENSG00000229425',]

mayo <- rows[rows$Study == "MAYO",] # 2 regions: 2 x 4 = 8 rows expected in source
mssm <- rows[rows$Study == "MSSM",] # 4 regions: 4 x 4 = 16 rows expected in source
rosmap <- rows[rows$Study == "ROSMAP",] # 3 regions: 3 x 4 = 12 rows expected in source

print(mayo)
print(mssm)
print(rosmap)
```

# abs(logfc) > 0: 3337 fails
AG-451
New RNA seq has 3337/722444 rows with lfc == 0
Source table has 0/745580 rows with lfc == 0

3337 rows -> 2998 unique ENSGs

```{r}
zero_fc <- rna_seq_differential_expression_new[rna_seq_differential_expression_new$logfc  == 0,]
zero_pv <- rna_seq_differential_expression_new[rna_seq_differential_expression_new$adj_p_va == 0,]
zero_fc_pv <- zero_fc[zero_fc$adj_p_val == 0, ]
print(zero_fc)
print(zero_pv)
print(zero_fc_pv)


```

```{r}
source_zero_fc <- rna_de_source[rna_de_source$logFC == 0 ,]
source_zero_pv <- rna_de_source[rna_de_source$adj.P.Val == 0 ,]

print(source_zero_fc)
print(source_zero_pv)

```
```{r}
zero_fc <- rna_seq_differential_expression_new[rna_seq_differential_expression_new$logfc  == 0,]
ensgs <- unique(zero_fc$ensembl_gene_id)


source_rows <- rna_de_source[rna_de_source$ensembl_gene_id %in% ensgs,]
print(source_rows)

```

```{r}
json_row <- rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == 'ENSG00000123684',]
json_refined <- json_row[json_row$tissue == "CBE",]

source_row <- rna_de_source[rna_de_source$ensembl_gene_id == "ENSG00000123684",]
source_refined <- source_row[source_row$Tissue == "CBE",]

print(json_refined)
print(source_refined)
```

***
# Other Validation
***

```{r}
rna_seq_differential_expression_new[rna_seq_differential_expression_new$hgnc_symbol == 'GSTM1', ]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$hgnc_symbol == 'CDH3', ]
rna_de_source[rna_de_source$hgnc_symbol == 'GSTM1', ]
rna_de_source[rna_de_source$hgnc_symbol == 'CDH3', ]
```

```{r}

genes <- rna_de_source[rna_de_source$hgnc_symbol %in% c('GSTM1','CDH3'),]
genes_tissue <- genes[genes$Tissue == 'IFG',]


```


How many genes are missing data for at least one region?
```{r}
counts <- rna_seq_differential_expression_new %>% count(ensembl_gene_id, sort = TRUE)
print(counts)
counts[counts$Freq < 36]
```


```{r}
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == 'ENSG00000123684',]
```


AG-350: do we still have genes with missing values in the new rnaseq data?

```{r}
rna_de_source[rna_de_source$adj.P.Val == 0,]
rna_de_source[rna_de_source$logFC == 0,]
rna_de_source[rna_de_source$CI.L == 0,]
rna_de_source[rna_de_source$CI.R == 0,]
```

```{r}
rna_seq_differential_expression_old[rna_seq_differential_expression_old$adj_p_val == 0, ]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$adj_p_val == 0, ]

rna_seq_differential_expression_old[rna_seq_differential_expression_old$logfc == 0, ]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$logfc == 0, ]

rna_seq_differential_expression_old[rna_seq_differential_expression_old$ci_l == 0, ]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ci_l == 0, ]

rna_seq_differential_expression_old[rna_seq_differential_expression_old$ci_r == 0, ]
rna_seq_differential_expression_new[rna_seq_differential_expression_new$ci_r == 0, ]

```



old vs new distributions

```{r}
#rna_de_source_old <- download_file("syn14237651", "rna_seq_source_old", "tsv")
tcx_model_old <- rna_de_source_old[rna_de_source_old$Model == "Diagnosis",]
tcx_sex_old <- rna_de_source_old[rna_de_source_old$Sex == "All",]
tcx_old <- tcx_model_old[tcx_model_old$Tissue == 'TCX',]
max(tcx_old$logFC)
```


```{r}
#rna_de_source <- download_file("syn27211942", "rna_seq_source", "tsv")
tcx_model <- rna_de_source[rna_de_source$Model == "Diagnosis",]
tcx_sex <- rna_de_source[rna_de_source$Sex == "All",]
tcx <- rna_de_source[rna_de_source$Tissue == 'TCX',]
max(tcx$logFC)
```

```{r}
length(unique(rna_de_source$ensembl_gene_id))
```

```{r}
sum(rna_seq_differential_expression_source$adj.P.Val > 1)
```

```{r}
sum(rna_seq_differential_expression_source$P.Value > 1)
```

```{r}
matches <- rna_seq_differential_expression_new[rna_seq_differential_expression_new$ensembl_gene_id == 'ENSG00000233009',]
matches[matches$adj_p_val < 0.05,]
```

```{r}

```

# l2fc and pval distributions (opacity and diameter tuning)

```{r}
l2fc <- rna_seq_differential_expression_new$logfc
smalls <- l2fc[l2fc < -0.8]
bigs <- l2fc[l2fc > 0.8]
hist(smalls)
hist(bigs)
```


use 1.5IQR to eliminate outliers?
```{r}
l2fc <- rna_seq_differential_expression_new$logfc
median <- median(l2fc)
q1 <- quantile(l2fc, c(0.25), names = FALSE)
q3 <- quantile(l2fc, c(0.75), names = FALSE)
IQR <- q3 - q1
max <- q3 + (1.5 * IQR)
min <- q1 - (1.5 * IQR)

cat(min, q1, median, q3, max)

```